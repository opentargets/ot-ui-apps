name: "Auto-Generate Tests for New Widgets"

on:
  workflow_dispatch:

jobs:
  detect-and-generate:
    name: Detect New Widgets & Generate Tests
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Fetch main branch for comparison
        run: git fetch origin main:main

      - name: Detect new widgets and pages
        id: detect
        run: node ${{ github.workspace }}/.github/scripts/detect-new-widgets.js
        env:
          GITHUB_BASE_REF: main

      - name: Generate tests and interactors
        if: steps.detect.outputs.has_new_widgets == 'true'
        run: node ${{ github.workspace }}/.github/scripts/generate-tests.js
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          NEW_WIDGETS_JSON: ${{ steps.detect.outputs.new_widgets }}

      - name: Check for generated files
        id: check_files
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changed files:"
            git status --porcelain
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create branch and PR with generated tests
        if: steps.check_files.outputs.has_changes == 'true'
        id: create_pr
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Create a new branch for generated tests
          GENERATED_BRANCH="auto-tests/${{ github.head_ref }}-${{ github.run_number }}"
          git checkout -b "$GENERATED_BRANCH"
          
          git add ${{ github.workspace }}/packages/platform-test/
          git commit -m "ðŸ¤– Auto-generated tests, interactors, and fixture updates for new widgets"
          git push origin "$GENERATED_BRANCH"
          
          echo "generated_branch=$GENERATED_BRANCH" >> $GITHUB_OUTPUT

      - name: Create PR for generated tests
        if: steps.check_files.outputs.has_changes == 'true'
        id: create_test_pr
        uses: actions/github-script@v7
        with:
          script: |
            const generatedBranch = '${{ steps.create_pr.outputs.generated_branch }}';
            const targetBranch = '${{ github.head_ref }}';
            
            // Create PR from generated tests branch to the original PR branch
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ¤– Auto-generated tests for ' + targetBranch,
              head: generatedBranch,
              base: targetBranch,
              body: `## ðŸ¤– Auto-Generated Tests\n\nThis PR contains auto-generated tests, interactors, and fixture updates for new widgets detected in #${{ github.event.pull_request.number }}.\n\n### Generated Files:\n- Interactors in \`packages/platform-test/POM/objects/widgets/\`\n- Test specs in \`packages/platform-test/e2e/pages/\`\n- Fixture updates in \`packages/platform-test/fixtures/testConfig.ts\`\n\n> **Note:** Please review the generated tests and adjust as needed. The LLM-generated code may require fine-tuning based on actual component behavior and data availability.\n\n---\n_Merge this PR to add the generated tests to your branch._`
            });
            
            core.setOutput('pr_number', pr.data.number);
            core.setOutput('pr_url', pr.data.html_url);
            return pr.data;

      - name: Comment on original PR with link
        if: steps.check_files.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const newWidgets = JSON.parse(process.env.NEW_WIDGETS_JSON || '[]');
            const widgetList = newWidgets.map(w => `- **${w.name}** (${w.entity})`).join('\n');
            const testPrUrl = '${{ steps.create_test_pr.outputs.pr_url }}';
            const testPrNumber = '${{ steps.create_test_pr.outputs.pr_number }}';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ¤– Auto-Generated Tests Available\n\nI detected the following new widgets/sections and generated tests for them:\n\n${widgetList}\n\n### ðŸ“‹ Review & Merge Generated Tests\n\nA separate PR has been created with the generated tests:\n\n**âž¡ï¸ [PR #${testPrNumber}: Auto-generated tests](${testPrUrl})**\n\nPlease review the generated code and merge that PR into this branch to include the tests.\n\n### Generated Files:\n- Interactors in \`packages/platform-test/POM/objects/widgets/\`\n- Test specs in \`packages/platform-test/e2e/pages/\`\n- Fixture updates in \`packages/platform-test/fixtures/testConfig.ts\`\n\n> **Note:** The LLM-generated code may require fine-tuning based on actual component behavior and data availability.`
            });
        env:
          NEW_WIDGETS_JSON: ${{ steps.detect.outputs.new_widgets }}

      - name: No new widgets detected
        if: steps.detect.outputs.has_new_widgets != 'true'
        run: echo "No new widgets or pages detected in this PR."
